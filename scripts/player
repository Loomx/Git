#!/bin/sh
#
# /usr/local/bin/player
#
# Depends: dmenu, mplayer


# Cache files:
AlbumCache=~/.mplayer/album_cache
TrackCache=~/.mplayer/track_cache

# Check music folders:
if stest -dlq -n "$AlbumCache" ~/Music; then
    # Update caches if anything has changed:
    printf "Jukebox\nDVD\n" >"$AlbumCache"
    stest -dl ~/Music | sort >>"$AlbumCache"
    stest -f ~/Music/*/* >"$TrackCache"
fi

# Set trap to clean up afterwards:
clean_up () { rm /tmp/mp_track /tmp/mp_tracklist; }
trap 'clean_up' EXIT

# Select an album:
Album=$( dmenu <"$AlbumCache" -i -l 40 ) || exit

case "$Album" in
    Jukebox)
        # Prompt for filters:
        Filters=$( dmenu </dev/null -p "Filters?" ) || exit

        if [ "$Filters" ]; then
            # Apply filters and shuffle tracks:
            set $( echo "$Filters" ) 
            for i; do 
                grep -Fi "$i" "$TrackCache"
            done | mplayer -playlist - -shuffle -identify >/tmp/mp_tracklist &

        else
            # No filters, so shuffle all tracks:
            mplayer -playlist "$TrackCache" -shuffle -identify >/tmp/mp_tracklist &
        fi
        ;;

    DVD)
        exec mplayer dvd://
        ;;

    *)
        # Album is selected, prompt to play or shuffle:
        Mode=$( printf "Play\nShuffle" | dmenu -i -l 2 ) || exit

        if [ "$Mode" = Shuffle ]; then
            # Shuffle album tracks:
            mplayer ~/Music/"$Album"/* -shuffle -identify >/tmp/mp_tracklist &

        else
            # Play album in order:
            mplayer ~/Music/"$Album"/* -identify >/tmp/mp_tracklist &
        fi
        ;;
esac

# Pause while mplayer starts:
sleep 1

# Loop while playing to store current track name:
while pgrep mplayer >/dev/null; do
    if [ ! /tmp/mp_tracklist -ot /tmp/mp_track ]; then
        tail -20 /tmp/mp_tracklist | awk -F "/" '/FILENAME/ { print $NF } { ORS="\0" }' >/tmp/mp_track
    fi
    sleep 1
done
